<%- include('../partials/header', { title: 'Admin Dashboard' }) %>

<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-value"><%= stats.totalUnions || 0 %></div>
    <div class="stat-label">Active Unions</div>
  </div>
  <div class="stat-card stat-card-trial">
    <div class="stat-value"><%= stats.totalTrials || 0 %></div>
    <div class="stat-label">On Trial</div>
  </div>
  <div class="stat-card">
    <div class="stat-value"><%= stats.totalUsers || 0 %></div>
    <div class="stat-label">Users</div>
  </div>
  <div class="stat-card">
    <div class="stat-value"><%= stats.totalBuckets || 0 %></div>
    <div class="stat-label">Buckets</div>
  </div>
  <div class="stat-card">
    <div class="stat-value"><%= stats.totalMembers || 0 %></div>
    <div class="stat-label">Members</div>
  </div>
</div>

<% if (pendingSignups && pendingSignups.length > 0) { %>
<div class="alert-banner">
  <strong><%= pendingSignups.length %> pending signup request<%= pendingSignups.length > 1 ? 's' : '' %></strong> awaiting payment confirmation.
  <a href="/admin/signups">Review now</a>
</div>
<% } %>

<div class="dashboard-sections">
  <% if (pendingSignups && pendingSignups.length > 0) { %>
  <section class="dashboard-section highlight-section">
    <div class="section-header">
      <h2>Pending Signups</h2>
      <a href="/admin/signups" class="btn btn-primary btn-sm">View All</a>
    </div>
    <table class="data-table">
      <thead>
        <tr>
          <th>Union Name</th>
          <th>Contact</th>
          <th>Submitted</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% pendingSignups.slice(0, 5).forEach(signup => { %>
          <tr>
            <td><strong><%= signup.union_name %></strong></td>
            <td><%= signup.contact_email %></td>
            <td><%= new Date(signup.created_at).toLocaleDateString() %></td>
            <td>
              <a href="/admin/signups/<%= signup.id %>" class="btn btn-primary btn-sm">Review</a>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </section>
  <% } %>

  <% if (typeof trials !== 'undefined' && trials && trials.length > 0) { %>
  <section class="dashboard-section trial-section">
    <div class="section-header">
      <h2>Trial Unions</h2>
      <a href="/admin/trials" class="btn btn-outline btn-sm">View All</a>
    </div>
    <table class="data-table">
      <thead>
        <tr>
          <th>Union Name</th>
          <th>Contact</th>
          <th>Days Left</th>
          <th>Usage</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% trials.slice(0, 5).forEach(trial => { %>
          <% const daysLeft = Math.max(0, Math.floor(trial.days_remaining || 0)); %>
          <tr>
            <td><a href="/admin/unions/<%= trial.id %>"><strong><%= trial.name %></strong></a></td>
            <td><%= trial.contact_email || '-' %></td>
            <td>
              <% if (daysLeft <= 7) { %>
                <span class="badge badge-danger"><%= daysLeft %> days</span>
              <% } else if (daysLeft <= 14) { %>
                <span class="badge badge-warning"><%= daysLeft %> days</span>
              <% } else { %>
                <span class="badge badge-success"><%= daysLeft %> days</span>
              <% } %>
            </td>
            <td><%= trial.bucket_count || 0 %> buckets, <%= trial.member_count || 0 %> members</td>
            <td>
              <form action="/admin/unions/<%= trial.id %>/grant-free-year" method="POST" class="inline-form" onsubmit="return confirm('Grant free year to <%= trial.name %>?')">
                <button type="submit" class="btn btn-success btn-sm">Grant Year</button>
              </form>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
    <% if (trials.length > 5) { %>
      <p><a href="/admin/trials">View all <%= trials.length %> trials</a></p>
    <% } %>
  </section>
  <% } %>

  <section class="dashboard-section">
    <div class="section-header">
      <h2>Active Unions</h2>
      <a href="/admin/unions/new" class="btn btn-primary btn-sm">Add Union</a>
    </div>
    <% const activeUnions = unions.filter(u => u.status === 'active'); %>
    <% if (activeUnions.length === 0) { %>
      <p class="empty-message">No active unions yet.</p>
    <% } else { %>
      <table class="data-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Status</th>
            <th>Buckets</th>
            <th>Members</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% activeUnions.slice(0, 5).forEach(union => { %>
            <tr>
              <td><a href="/admin/unions/<%= union.id %>"><%= union.name %></a></td>
              <td><span class="badge badge-success">Active</span></td>
              <td><%= union.bucket_count || 0 %></td>
              <td><%= union.member_count || 0 %></td>
              <td>
                <a href="/admin/unions/<%= union.id %>" class="btn btn-outline btn-sm">View</a>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
      <% if (activeUnions.length > 5) { %>
        <p><a href="/admin/unions">View all <%= activeUnions.length %> unions</a></p>
      <% } %>
    <% } %>
  </section>

  <section class="dashboard-section">
    <div class="section-header">
      <h2>Recent Users</h2>
      <a href="/admin/users/new" class="btn btn-primary btn-sm">Add User</a>
    </div>
    <% if (users.length === 0) { %>
      <p class="empty-message">No users yet.</p>
    <% } else { %>
      <table class="data-table">
        <thead>
          <tr>
            <th>Email</th>
            <th>Name</th>
            <th>Role</th>
            <th>Union</th>
          </tr>
        </thead>
        <tbody>
          <% users.slice(0, 5).forEach(u => { %>
            <tr>
              <td><%= u.email %></td>
              <td><%= u.first_name || '' %> <%= u.last_name || '' %></td>
              <td><span class="badge badge-<%= u.role === 'super_admin' ? 'primary' : 'secondary' %>"><%= u.role === 'super_admin' ? 'Super Admin' : 'Union Admin' %></span></td>
              <td><%= u.union_name || '-' %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
      <% if (users.length > 5) { %>
        <p><a href="/admin/users">View all <%= users.length %> users</a></p>
      <% } %>
    <% } %>
  </section>
</div>

<style>
.alert-banner {
  background: #fef3c7;
  border: 1px solid #f59e0b;
  color: #92400e;
  padding: 1rem 1.5rem;
  border-radius: 8px;
  margin-bottom: 2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.alert-banner a {
  color: #92400e;
  font-weight: 600;
}
.highlight-section {
  border: 2px solid #f59e0b;
  background: #fffbeb;
}
.trial-section {
  border: 2px solid #3b82f6;
  background: #eff6ff;
}
.stat-card-trial {
  border-left: 4px solid #3b82f6;
}
[data-theme="dark"] .trial-section {
  background: #1e3a5f;
  border-color: #3b82f6;
}
[data-theme="dark"] .highlight-section {
  background: #422006;
  border-color: #f59e0b;
}
</style>
