<%- include('../partials/header', { title: 'Admin Dashboard' }) %>

<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-value"><%= stats.totalUnions || 0 %></div>
    <div class="stat-label">Active Unions</div>
  </div>
  <div class="stat-card stat-card-trial">
    <div class="stat-value"><%= stats.totalTrials || 0 %></div>
    <div class="stat-label">On Trial</div>
  </div>
  <div class="stat-card">
    <div class="stat-value"><%= stats.totalUsers || 0 %></div>
    <div class="stat-label">Users</div>
  </div>
  <div class="stat-card">
    <div class="stat-value"><%= stats.totalBuckets || 0 %></div>
    <div class="stat-label">Units/Sectionals</div>
  </div>
  <div class="stat-card">
    <div class="stat-value"><%= stats.totalMembers || 0 %></div>
    <div class="stat-label">Members</div>
  </div>
</div>

<!-- Backup Status Card -->
<% if (typeof backupStatus !== 'undefined' && backupStatus) { %>
<div class="backup-status-card">
  <div class="backup-header">
    <h3>Backup Status</h3>
    <% if (backupStatus.status === 'success') { %>
      <span class="badge badge-success">Healthy</span>
    <% } else if (backupStatus.status === 'partial') { %>
      <span class="badge badge-warning">Partial</span>
    <% } else { %>
      <span class="badge badge-danger">Error</span>
    <% } %>
  </div>
  <div class="backup-details">
    <div class="backup-stat">
      <span class="backup-label">Last Backup</span>
      <span class="backup-value"><%= backupStatus.lastBackupFormatted || 'Never' %></span>
    </div>
    <div class="backup-stat">
      <span class="backup-label">Backups Stored</span>
      <span class="backup-value"><%= backupStatus.backupCount || 0 %></span>
    </div>
    <div class="backup-stat">
      <span class="backup-label">Total Size</span>
      <span class="backup-value"><%= backupStatus.totalSize || 'N/A' %></span>
    </div>
  </div>
  <div class="backup-actions">
    <form action="/admin/backup/run" method="POST" class="inline-form" onsubmit="return confirm('Run a backup now?')">
      <button type="submit" class="btn btn-primary btn-sm">Run Backup Now</button>
    </form>
  </div>
</div>
<% } else { %>
<div class="backup-status-card backup-status-unknown">
  <div class="backup-header">
    <h3>Backup Status</h3>
    <span class="badge badge-secondary">Unknown</span>
  </div>
  <p>No backup information available. Run a backup to initialize.</p>
  <div class="backup-actions">
    <form action="/admin/backup/run" method="POST" class="inline-form">
      <button type="submit" class="btn btn-primary btn-sm">Run Backup Now</button>
    </form>
  </div>
</div>
<% } %>

<% if (pendingSignups && pendingSignups.length > 0) { %>
<div class="alert-banner">
  <strong><%= pendingSignups.length %> pending signup request<%= pendingSignups.length > 1 ? 's' : '' %></strong> awaiting payment confirmation.
  <a href="/admin/signups">Review now</a>
</div>
<% } %>

<div class="dashboard-sections">
  <% if (pendingSignups && pendingSignups.length > 0) { %>
  <section class="dashboard-section highlight-section">
    <div class="section-header">
      <h2>Pending Signups</h2>
      <a href="/admin/signups" class="btn btn-primary btn-sm">View All</a>
    </div>
    <table class="data-table">
      <thead>
        <tr>
          <th>Union Name</th>
          <th>Contact</th>
          <th>Submitted</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% pendingSignups.slice(0, 5).forEach(signup => { %>
          <tr>
            <td><strong><%= signup.union_name %></strong></td>
            <td><%= signup.contact_email %></td>
            <td><%= new Date(signup.created_at).toLocaleDateString() %></td>
            <td>
              <a href="/admin/signups/<%= signup.id %>" class="btn btn-primary btn-sm">Review</a>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </section>
  <% } %>

  <% if (typeof trials !== 'undefined' && trials && trials.length > 0) { %>
  <section class="dashboard-section trial-section">
    <div class="section-header">
      <h2>Trial Unions</h2>
      <a href="/admin/trials" class="btn btn-outline btn-sm">View All</a>
    </div>
    <table class="data-table">
      <thead>
        <tr>
          <th>Union Name</th>
          <th>Contact</th>
          <th>Days Left</th>
          <th>Usage</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% trials.slice(0, 5).forEach(trial => { %>
          <% const daysLeft = Math.max(0, Math.floor(trial.days_remaining || 0)); %>
          <tr>
            <td><a href="/admin/unions/<%= trial.id %>"><strong><%= trial.name %></strong></a></td>
            <td><%= trial.contact_email || '-' %></td>
            <td>
              <% if (daysLeft <= 7) { %>
                <span class="badge badge-danger"><%= daysLeft %> days</span>
              <% } else if (daysLeft <= 14) { %>
                <span class="badge badge-warning"><%= daysLeft %> days</span>
              <% } else { %>
                <span class="badge badge-success"><%= daysLeft %> days</span>
              <% } %>
            </td>
            <td><%= trial.bucket_count || 0 %> buckets, <%= trial.member_count || 0 %> members</td>
            <td>
              <form action="/admin/unions/<%= trial.id %>/grant-free-year" method="POST" class="inline-form" onsubmit="return confirm('Grant free year to <%= trial.name %>?')">
                <button type="submit" class="btn btn-success btn-sm">Grant Year</button>
              </form>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
    <% if (trials.length > 5) { %>
      <p><a href="/admin/trials">View all <%= trials.length %> trials</a></p>
    <% } %>
  </section>
  <% } %>

  <section class="dashboard-section">
    <div class="section-header">
      <h2>Active Unions</h2>
      <a href="/admin/unions/new" class="btn btn-primary btn-sm">Add Union</a>
    </div>
    <% const activeUnions = unions.filter(u => u.status === 'active'); %>
    <% if (activeUnions.length === 0) { %>
      <p class="empty-message">No active unions yet.</p>
    <% } else { %>
      <table class="data-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Tier</th>
            <th>Units/Sectionals</th>
            <th>Members</th>
            <th>Compliance</th>
            <th>Expires</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% activeUnions.slice(0, 10).forEach(union => { %>
            <% const compliance = (union.member_count > 0) ? Math.round((union.good_standing_count || 0) / union.member_count * 100) : 0; %>
            <tr>
              <td><a href="/admin/unions/<%= union.id %>"><%= union.name %></a></td>
              <td>
                <% if (union.payment_status === 'paid') { %>
                  <span class="badge badge-success">Paid</span>
                <% } else if (union.payment_status === 'free') { %>
                  <span class="badge badge-primary">Free</span>
                <% } else if (union.payment_status === 'trial') { %>
                  <span class="badge badge-warning">Trial</span>
                <% } else { %>
                  <span class="badge badge-secondary">Unpaid</span>
                <% } %>
              </td>
              <td><%= union.bucket_count || 0 %></td>
              <td><%= union.member_count || 0 %></td>
              <td><span class="compliance-rate"><%= compliance %>%</span></td>
              <td><%= union.subscription_end ? new Date(union.subscription_end).toLocaleDateString() : '-' %></td>
              <td>
                <a href="/admin/unions/<%= union.id %>" class="btn btn-outline btn-sm">View</a>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
      <% if (activeUnions.length > 5) { %>
        <p><a href="/admin/unions">View all <%= activeUnions.length %> unions</a></p>
      <% } %>
    <% } %>
  </section>

  <section class="dashboard-section">
    <div class="section-header">
      <h2>Recent Users</h2>
      <a href="/admin/users/new" class="btn btn-primary btn-sm">Add User</a>
    </div>
    <% if (users.length === 0) { %>
      <p class="empty-message">No users yet.</p>
    <% } else { %>
      <table class="data-table">
        <thead>
          <tr>
            <th>Email</th>
            <th>Name</th>
            <th>Role</th>
            <th>Union</th>
          </tr>
        </thead>
        <tbody>
          <% users.slice(0, 5).forEach(u => { %>
            <tr>
              <td><%= u.email %></td>
              <td><%= u.first_name || '' %> <%= u.last_name || '' %></td>
              <td>
                <% if (u.role === 'super_admin') { %>
                  <span class="badge badge-primary">Super Admin</span>
                <% } else if (u.role === 'union_president') { %>
                  <span class="badge badge-success">President</span>
                <% } else if (u.role === 'union_secretary') { %>
                  <span class="badge badge-secondary">Recording Secretary</span>
                <% } else { %>
                  <span class="badge badge-secondary"><%= u.role %></span>
                <% } %>
              </td>
              <td><%= u.union_name || '-' %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
      <% if (users.length > 5) { %>
        <p><a href="/admin/users">View all <%= users.length %> users</a></p>
      <% } %>
    <% } %>
  </section>
</div>

<style>
.alert-banner {
  background: #fef3c7;
  border: 1px solid #f59e0b;
  color: #92400e;
  padding: 1rem 1.5rem;
  border-radius: 8px;
  margin-bottom: 2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.alert-banner a {
  color: #92400e;
  font-weight: 600;
}
.highlight-section {
  border: 2px solid #f59e0b;
  background: #fffbeb;
}
.trial-section {
  border: 2px solid #3b82f6;
  background: #eff6ff;
}
.stat-card-trial {
  border-left: 4px solid #3b82f6;
}
[data-theme="dark"] .trial-section {
  background: #1e3a5f;
  border-color: #3b82f6;
}
[data-theme="dark"] .highlight-section {
  background: #422006;
  border-color: #f59e0b;
}
/* Backup Status Card */
.backup-status-card {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 2rem;
  color: white;
}
.backup-status-card.backup-status-unknown {
  background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
}
.backup-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}
.backup-header h3 {
  margin: 0;
  font-size: 1.25rem;
  font-weight: 600;
}
.backup-details {
  display: flex;
  gap: 2rem;
  margin-bottom: 1rem;
  flex-wrap: wrap;
}
.backup-stat {
  display: flex;
  flex-direction: column;
}
.backup-label {
  font-size: 0.75rem;
  opacity: 0.8;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.backup-value {
  font-size: 1.125rem;
  font-weight: 600;
}
.backup-actions {
  margin-top: 0.5rem;
}
.backup-status-card .btn-primary {
  background: rgba(255,255,255,0.2);
  border: 1px solid rgba(255,255,255,0.3);
  color: white;
}
.backup-status-card .btn-primary:hover {
  background: rgba(255,255,255,0.3);
}
[data-theme="dark"] .backup-status-card {
  background: linear-gradient(135deg, #065f46 0%, #064e3b 100%);
}
</style>
