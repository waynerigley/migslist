<%- include('../../partials/header', {
  title: user ? 'Edit User' : 'Create User',
  backLink: '/admin/users'
}) %>

<div class="form-container">
  <form action="<%= user ? '/admin/users/' + user.id : '/admin/users' %>" method="POST">
    <div class="form-row">
      <div class="form-group">
        <label for="firstName">First Name</label>
        <input type="text" id="firstName" name="firstName" value="<%= user ? user.first_name || '' : '' %>">
      </div>
      <div class="form-group">
        <label for="lastName">Last Name</label>
        <input type="text" id="lastName" name="lastName" value="<%= user ? user.last_name || '' : '' %>">
      </div>
    </div>

    <div class="form-group">
      <label for="email">Email</label>
      <input type="email" id="email" name="email" value="<%= user ? user.email : '' %>" required>
    </div>

    <% if (!user) { %>
      <div class="form-group">
        <label for="password">Password</label>
        <input type="password" id="password" name="password" required minlength="8">
        <small>Minimum 8 characters</small>
      </div>

      <div class="form-group">
        <label for="role">Role</label>
        <select id="role" name="role" required onchange="toggleUnionSelect()">
          <option value="union_admin">Union Admin</option>
          <option value="super_admin">Super Admin</option>
        </select>
      </div>
    <% } %>

    <div class="form-group" id="unionGroup">
      <label for="unionId">Union</label>
      <select id="unionId" name="unionId">
        <option value="">Select a union</option>
        <% unions.forEach(union => { %>
          <option value="<%= union.id %>" <%= user && user.union_id === union.id ? 'selected' : '' %>><%= union.name %></option>
        <% }) %>
      </select>
      <small>Required for union admins</small>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn btn-primary"><%= user ? 'Update' : 'Create' %> User</button>
      <a href="/admin/users" class="btn btn-outline">Cancel</a>
    </div>
  </form>

  <% if (user) { %>
    <hr class="form-divider">

    <h3>Reset Password</h3>
    <form action="/admin/users/<%= user.id %>/reset-password" method="POST">
      <div class="form-group">
        <label for="newPassword">New Password</label>
        <input type="password" id="newPassword" name="password" minlength="8">
        <small>Minimum 8 characters</small>
      </div>
      <button type="submit" class="btn btn-outline">Reset Password</button>
    </form>

    <hr class="form-divider">

    <h3>Danger Zone</h3>
    <form action="/admin/users/<%= user.id %>/delete" method="POST" onsubmit="return confirm('Are you sure you want to delete this user?')">
      <button type="submit" class="btn btn-danger">Delete User</button>
    </form>
  <% } %>
</div>

<script>
function toggleUnionSelect() {
  const role = document.getElementById('role');
  const unionGroup = document.getElementById('unionGroup');
  if (role && role.value === 'super_admin') {
    unionGroup.style.display = 'none';
  } else {
    unionGroup.style.display = 'block';
  }
}
document.addEventListener('DOMContentLoaded', toggleUnionSelect);
</script>
