<%- include('../../partials/header', { title: 'Manage Users', backLink: '/admin' }) %>

<div class="section-header">
  <div></div>
  <a href="/admin/users/new" class="btn btn-primary">Add User</a>
</div>

<% if (users.length === 0) { %>
  <div class="empty-state">
    <h3>No users yet</h3>
    <p>Create your first user to get started.</p>
    <a href="/admin/users/new" class="btn btn-primary">Create User</a>
  </div>
<% } else { %>
  <%
    // Separate super admins from union users
    const superAdmins = users.filter(u => u.role === 'super_admin');
    const unionUsers = users.filter(u => u.role !== 'super_admin');

    // Group union users by union
    const unionGroups = {};
    unionUsers.forEach(u => {
      const unionKey = u.union_id || 'no_union';
      const unionName = u.union_name || 'No Union Assigned';
      if (!unionGroups[unionKey]) {
        unionGroups[unionKey] = { name: unionName, users: [] };
      }
      unionGroups[unionKey].users.push(u);
    });

    // Sort users within each union: presidents first, then recorders, then admins
    const roleOrder = { 'union_president': 1, 'union_secretary': 2, 'union_admin': 3 };
    Object.values(unionGroups).forEach(group => {
      group.users.sort((a, b) => (roleOrder[a.role] || 99) - (roleOrder[b.role] || 99));
    });
  %>

  <% if (superAdmins.length > 0) { %>
  <div class="user-group">
    <div class="group-header">
      <h3>Super Administrators</h3>
    </div>
    <table class="data-table">
      <thead>
        <tr>
          <th>Email</th>
          <th>Name</th>
          <th>Role</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% superAdmins.forEach(u => { %>
          <tr>
            <td><%= u.email %></td>
            <td><%= u.first_name || '' %> <%= u.last_name || '' %></td>
            <td><span class="badge badge-primary">Super Admin</span></td>
            <td><%= new Date(u.created_at).toLocaleDateString() %></td>
            <td class="actions">
              <a href="/admin/users/<%= u.id %>/edit" class="btn btn-outline btn-sm">Edit</a>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
  <% } %>

  <% Object.entries(unionGroups).forEach(([unionId, group]) => { %>
  <div class="user-group">
    <div class="group-header">
      <h3><%= group.name %></h3>
      <span class="group-count"><%= group.users.length %> user<%= group.users.length !== 1 ? 's' : '' %></span>
    </div>
    <table class="data-table">
      <thead>
        <tr>
          <th>Email</th>
          <th>Name</th>
          <th>Role</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% group.users.forEach(u => { %>
          <tr>
            <td><%= u.email %></td>
            <td><%= u.first_name || '' %> <%= u.last_name || '' %></td>
            <td>
              <% if (u.role === 'union_president') { %>
                <span class="badge badge-president">President</span>
              <% } else if (u.role === 'union_secretary') { %>
                <span class="badge badge-recorder">Recorder</span>
              <% } else { %>
                <span class="badge badge-secondary">Union Admin</span>
              <% } %>
            </td>
            <td><%= new Date(u.created_at).toLocaleDateString() %></td>
            <td class="actions">
              <a href="/admin/users/<%= u.id %>/edit" class="btn btn-outline btn-sm">Edit</a>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
  <% }) %>
<% } %>

<style>
.user-group {
  margin-bottom: 2rem;
  background: var(--bg-primary);
  border-radius: var(--radius);
  border: 1px solid var(--border-color);
  overflow: hidden;
}
.group-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 1.5rem;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-color);
}
.group-header h3 {
  margin: 0;
  font-size: 1.1rem;
  color: var(--text-primary);
}
.group-count {
  font-size: 0.875rem;
  color: var(--text-secondary);
}
.user-group .data-table {
  margin: 0;
  border: none;
  border-radius: 0;
}
.user-group .data-table thead {
  background: var(--bg-primary);
}
.badge-president {
  background: #059669;
  color: white;
}
.badge-recorder {
  background: #f59e0b;
  color: white;
}
</style>
